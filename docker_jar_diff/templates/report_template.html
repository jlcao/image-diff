<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dockeré•œåƒå·®å¼‚æ¯”å¯¹æŠ¥å‘Š</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .header-info {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
        }
        
        .header-info-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .header-info-item strong {
            color: #2c3e50;
        }
        
        .directory-table {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        tr:hover {
            background-color: #f5f5f5;
        }
        
        .expand-icon {
            cursor: pointer;
            margin-right: 5px;
            color: #666;
        }
        
        .expand-icon.expanded {
            transform: rotate(90deg);
        }
        
        .folder-icon {
            margin-right: 5px;
            color: #ff9800;
        }
        
        .file-icon {
            margin-right: 5px;
            color: #2196f3;
        }
        
        .diff-indicator {
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
            white-space: nowrap;
        }
        
        .diff-content {
            background-color: #ffebee;
            color: #c62828;
        }
        
        .diff-size {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        
        .diff-mtime {
            background-color: #fff3e0;
            color: #ef6c00;
        }
        
        .only-in-1 {
            background-color: #e3f2fd;
            color: #1565c0;
        }
        
        .only-in-2 {
            background-color: #f3e5f5;
            color: #7b1fa2;
        }
        
        .type-mismatch {
            background-color: #ffecb3;
            color: #f57c00;
        }
        
        .file-info-column {
            font-size: 12px;
        }
        
        .file-info-item {
            margin-bottom: 5px;
        }
        
        .file-info-item:last-child {
            margin-bottom: 0;
        }
        
        .size-info {
            color: #2e7d32;
        }
        
        .mtime-info {
            color: #ef6c00;
        }
        
        .md5-info {
            color: #666;
            font-family: monospace;
            font-size: 11px;
        }
        
        .archive-indicator {
            color: #4caf50;
            font-size: 12px;
            margin-left: 5px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            text-align: center;
            padding: 40px;
            color: #c62828;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Dockeré•œåƒå·®å¼‚æ¯”å¯¹æŠ¥å‘Š</h1>
        
        <div class="header-info">
            <div class="header-info-item">
                <strong>æ¯”å¯¹æ—¶é—´:</strong>
                <span id="compare-time">{{timestamp}}</span>
            </div>
            <div class="header-info-item">
                <strong>é•œåƒ1:</strong>
                <span id="image1-name"></span>
            </div>
            <div class="header-info-item">
                <strong>é•œåƒ2:</strong>
                <span id="image2-name"></span>
            </div>
            <div class="header-info-item">
                <strong>æ¯”å¯¹ç›®å½•:</strong>
                <span id="compare-dir"></span>
            </div>
            <div class="header-info-item">
                <strong>å·®å¼‚æ–‡ä»¶æ•°é‡:</strong>
                <span id="diff-count"></span>
            </div>
        </div>
        
        <div class="directory-table">
            <div class="table-container">
                <div id="loading" class="loading">æ­£åœ¨åŠ è½½å·®å¼‚æ•°æ®...</div>
                <div id="error" class="error" style="display: none;">åŠ è½½å·®å¼‚æ•°æ®å¤±è´¥</div>
                <table id="diff-table" style="display: none;">
                    <thead>
                        <tr>
                            <th>ç›®å½•</th>
                            <th>å·®å¼‚ç±»å‹</th>
                            <th id="file-info-1">é•œåƒä¸€æ–‡ä»¶ä¿¡æ¯</th>
                            <th id="file-info-2">é•œåƒäºŒæ–‡ä»¶ä¿¡æ¯</th>
                        </tr>
                    </thead>
                    <tbody id="diff-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // åµŒå…¥å¼å·®å¼‚æ•°æ®
        const diffData = {{diff_data}};
        
        // å·®å¼‚ç±»å‹ä¸­æ–‡æ˜ å°„
        const DIFF_TYPE_MAP = {
            'content_diff': 'å†…å®¹å·®å¼‚',
            'size_diff': 'å¤§å°å·®å¼‚',
            'mtime_diff': 'æ—¶é—´å·®å¼‚',
            'only_in_1': 'ä»…åœ¨é•œåƒ1',
            'only_in_2': 'ä»…åœ¨é•œåƒ2',
            'type_mismatch': 'ç±»å‹ä¸åŒ¹é…'
        };

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatSize(size) {
            if (size == null) return 'N/A';
            const units = ['B', 'KB', 'MB', 'GB', 'TB'];
            let unitIndex = 0;
            while (size >= 1024 && unitIndex < units.length - 1) {
                size /= 1024;
                unitIndex++;
            }
            return `${size.toFixed(2)} ${units[unitIndex]}`;
        }
        
        // æ ¼å¼åŒ–æ—¶é—´
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return dateString;
                
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                const seconds = String(date.getSeconds()).padStart(2, '0');
                
                return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
            } catch (error) {
                return dateString;
            }
        }

        // æ„å»ºç›®å½•ç»“æ„
        function buildDirectoryStructure(differences) {
            const structure = {};
            
            function addToStructure(path, diff) {
                const parts = path.split('/');
                let current = structure;
                
                // æŸ¥æ‰¾å½’æ¡£æ–‡ä»¶çš„ä½ç½®ï¼ˆæ— è®ºæ˜¯å¤„ç†å½’æ¡£æ–‡ä»¶æœ¬èº«è¿˜æ˜¯å…¶å†…å®¹ï¼‰
                let archiveIndex = -1;
                for (let i = 0; i < parts.length; i++) {
                    const part = parts[i];
                    // æ£€æŸ¥æ˜¯å¦æ˜¯å½’æ¡£æ–‡ä»¶
                    if (part.toLowerCase().endsWith('.jar') || part.toLowerCase().endsWith('.zip')) {
                        archiveIndex = i;
                        break;
                    }
                }
                
                // ä¸ºæ¯ä¸ªè·¯å¾„éƒ¨åˆ†åˆ›å»ºç›®å½•èŠ‚ç‚¹ï¼Œç›´åˆ°å½’æ¡£æ–‡ä»¶æˆ–æ™®é€šæ–‡ä»¶
                const targetIndex = archiveIndex !== -1 ? archiveIndex : parts.length - 1;
                for (let i = 0; i < targetIndex; i++) {
                    const part = parts[i];
                    if (!current[part]) {
                        current[part] = { type: 'directory', children: {} };
                    } else if (current[part].type === 'file') {
                        // å¦‚æœè¯¥èŠ‚ç‚¹å·²ç»æ˜¯æ–‡ä»¶èŠ‚ç‚¹ï¼Œå°†å…¶è½¬æ¢ä¸ºç›®å½•èŠ‚ç‚¹
                        const fileInfo = current[part];
                        current[part] = { type: 'directory', children: {} };
                        current[part].children[part] = fileInfo;
                    }
                    current = current[part].children;
                }
                
                if (archiveIndex !== -1) {
                    // å¤„ç†å½’æ¡£æ–‡ä»¶èŠ‚ç‚¹
                    const archiveName = parts[archiveIndex];
                    
                    // åˆ›å»ºæˆ–æ›´æ–°å½’æ¡£æ–‡ä»¶èŠ‚ç‚¹
                    if (!current[archiveName]) {
                        current[archiveName] = { type: 'directory', children: {} };
                    } else if (current[archiveName].type === 'file') {
                        // å¦‚æœå·²ç»æ˜¯æ–‡ä»¶èŠ‚ç‚¹ï¼Œè½¬æ¢ä¸ºç›®å½•èŠ‚ç‚¹
                        const fileInfo = current[archiveName];
                        current[archiveName] = { type: 'directory', children: {} };
                        current[archiveName].children[archiveName] = fileInfo;
                    }
                    
                    // å¦‚æœæ˜¯å½’æ¡£æ–‡ä»¶æœ¬èº«çš„å·®å¼‚ï¼Œæ·»åŠ diffä¿¡æ¯
                    if (diff.is_archive) {
                        current[archiveName].diff = diff;
                    }
                    
                    // å¦‚æœè¿˜æœ‰å­è·¯å¾„ï¼ˆå½’æ¡£æ–‡ä»¶å†…å®¹ï¼‰ï¼Œç»§ç»­å¤„ç†
                    if (parts.length > archiveIndex + 1) {
                        // å¤„ç†å½’æ¡£æ–‡ä»¶å†…éƒ¨å†…å®¹
                        let contentCurrent = current[archiveName].children;
                        
                        // å¤„ç†å½’æ¡£æ–‡ä»¶å†…éƒ¨çš„ç›®å½•å’Œæ–‡ä»¶
                        for (let i = archiveIndex + 1; i < parts.length - 1; i++) {
                            const part = parts[i];
                            if (!contentCurrent[part]) {
                                contentCurrent[part] = { type: 'directory', children: {} };
                            } else if (contentCurrent[part].type === 'file') {
                                // å¦‚æœè¯¥èŠ‚ç‚¹å·²ç»æ˜¯æ–‡ä»¶èŠ‚ç‚¹ï¼Œå°†å…¶è½¬æ¢ä¸ºç›®å½•èŠ‚ç‚¹
                                const fileInfo = contentCurrent[part];
                                contentCurrent[part] = { type: 'directory', children: {} };
                                contentCurrent[part].children[part] = fileInfo;
                            }
                            contentCurrent = contentCurrent[part].children;
                        }
                        
                        // æ·»åŠ å½’æ¡£æ–‡ä»¶å†…éƒ¨çš„æ–‡ä»¶èŠ‚ç‚¹
                        const fileName = parts[parts.length - 1];
                        contentCurrent[fileName] = { type: 'file', diff: diff };
                    }
                } else {
                    // æ ¹æ®å·®å¼‚ç±»å‹æ·»åŠ èŠ‚ç‚¹
                    const fileName = parts[parts.length - 1];
                    if (diff.type === 'directory') {
                        // æ·»åŠ ç›®å½•èŠ‚ç‚¹
                        current[fileName] = { type: 'directory', children: {}, diff: diff };
                    } else {
                        // æ·»åŠ æ™®é€šæ–‡ä»¶èŠ‚ç‚¹
                        current[fileName] = { type: 'file', diff: diff };
                    }
                }
            }
            
            // å¤„ç†ä¸»å·®å¼‚
            differences.forEach(diff => {
                addToStructure(diff.path, diff);
                
                // å¤„ç†å½’æ¡£æ–‡ä»¶å·®å¼‚
                if (diff.is_archive && diff.archive_diff) {
                    diff.archive_diff.forEach(archiveDiff => {
                        // ä¿æŒå½’æ¡£æ–‡ä»¶çš„å®Œæ•´è·¯å¾„
                        addToStructure(archiveDiff.path, archiveDiff);
                    });
                }
            });
            
            return structure;
        }

        // æ¸²æŸ“ç›®å½•ç»“æ„
        function renderDirectoryStructure(structure, parentElement, indent = 0) {
            for (const [name, node] of Object.entries(structure)) {
                const row = document.createElement('tr');
                
                // ç›®å½•åˆ—
                const pathCell = document.createElement('td');
                pathCell.style.paddingLeft = `${indent * 5}px`;

               
                
                if (node.type === 'directory') {
                    // ç›®å½•èŠ‚ç‚¹
                    const expandIcon = document.createElement('span');
                    expandIcon.className = 'expand-icon';
                    expandIcon.textContent = 'â–¶';
                    expandIcon.onclick = (e) => toggleDirectory(e, node, row);
                    
                    const folderIcon = document.createElement('span');
                    folderIcon.className = 'folder-icon';
                    folderIcon.textContent = 'ğŸ“';
                    
                    const folderName = document.createElement('span');
                    folderName.textContent = name;
                    
                    pathCell.appendChild(expandIcon);
                    pathCell.appendChild(folderIcon);
                    pathCell.appendChild(folderName);
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰æ¯”å¯¹ä¿¡æ¯ï¼ˆå½’æ¡£æ–‡ä»¶ç›®å½•åº”è¯¥æœ‰ï¼‰
                    let typeCell, info1Cell, info2Cell;
                    if (node.diff) {
                        // å·®å¼‚ç±»å‹åˆ—
                        typeCell = document.createElement('td');
                        const diffIndicator = document.createElement('span');
                        diffIndicator.className = `diff-indicator ${node.diff.type}`;
                        diffIndicator.textContent = DIFF_TYPE_MAP[node.diff.type] || node.diff.type;
                        typeCell.appendChild(diffIndicator);
                        
                        // é•œåƒä¸€æ–‡ä»¶ä¿¡æ¯åˆ—
                        info1Cell = document.createElement('td');
                        info1Cell.className = 'file-info-column';
                        renderFileInfo(info1Cell, node.diff.item1);
                        
                        // é•œåƒäºŒæ–‡ä»¶ä¿¡æ¯åˆ—
                        info2Cell = document.createElement('td');
                        info2Cell.className = 'file-info-column';
                        renderFileInfo(info2Cell, node.diff.item2);
                    } else {
                        // æ™®é€šç›®å½•ï¼Œå…¶ä»–åˆ—ç•™ç©º
                        typeCell = document.createElement('td');
                        info1Cell = document.createElement('td');
                        info2Cell = document.createElement('td');
                    }
                    
                    row.appendChild(pathCell);
                    row.appendChild(typeCell);
                    row.appendChild(info1Cell);
                    row.appendChild(info2Cell);
                    
                    parentElement.appendChild(row);
                    
                    // åˆ›å»ºå­èŠ‚ç‚¹å®¹å™¨
                    const childrenContainer = document.createElement('tr');
                    childrenContainer.className = 'children-container';
                    
                    // è®¡ç®—å­èŠ‚ç‚¹æ•°é‡
                    const childCount = Object.keys(node.children).length;
                    
                    // åˆ¤æ–­æ˜¯å¦æ˜¯å½’æ¡£æ–‡ä»¶ç›®å½•ï¼ˆjaræˆ–zipï¼‰
                    const isArchiveDirectory = name.toLowerCase().endsWith('.jar') || name.toLowerCase().endsWith('.zip');
                    
                    // é™¤äº†jaråŒ…å’ŒzipåŒ…ï¼Œå…¶ä»–èŠ‚ç‚¹é»˜è®¤å…¨éƒ¨å±•å¼€
                    if (!isArchiveDirectory) {
                        childrenContainer.style.display = 'table-row';
                        expandIcon.classList.add('expanded');
                        expandIcon.textContent = 'â–¼';
                    } else {
                        childrenContainer.style.display = 'none';
                    }
                    
                    const childrenCell = document.createElement('td');
                    childrenCell.colSpan = 4;
                    
                    const childrenTable = document.createElement('table');
                    childrenTable.style.width = '100%';
                    childrenTable.style.borderCollapse = 'collapse';
                    
                    const childrenBody = document.createElement('tbody');
                    childrenTable.appendChild(childrenBody);
                    childrenCell.appendChild(childrenTable);
                    childrenContainer.appendChild(childrenCell);
                    parentElement.appendChild(childrenContainer);
                    
                    // é€’å½’æ¸²æŸ“å­ç›®å½•
                    renderDirectoryStructure(node.children, childrenBody, indent + 1);
                } else {
                    pathCell.style.fontSize = 'small';
                    // æ–‡ä»¶èŠ‚ç‚¹
                    const fileIcon = document.createElement('span');
                    fileIcon.className = 'file-icon';
                    fileIcon.textContent = 'ğŸ“„';
                    
                    const fileName = document.createElement('span');
                    fileName.textContent = name;
                    
                    // æ£€æŸ¥æ˜¯å¦æ˜¯å½’æ¡£æ–‡ä»¶
                    if (name.toLowerCase().endsWith('.jar') || name.toLowerCase().endsWith('.zip')) {
                        const archiveIndicator = document.createElement('span');
                        archiveIndicator.className = 'archive-indicator';
                        archiveIndicator.textContent = '(å½’æ¡£æ–‡ä»¶)';
                        
                        pathCell.appendChild(fileIcon);
                        pathCell.appendChild(fileName);
                        pathCell.appendChild(archiveIndicator);
                    } else {
                        pathCell.appendChild(fileIcon);
                        pathCell.appendChild(fileName);
                    }
                    
                    // å·®å¼‚ç±»å‹åˆ—
                    const typeCell = document.createElement('td');
                    const diffIndicator = document.createElement('span');
                    diffIndicator.className = `diff-indicator ${node.diff.type}`;
                    diffIndicator.textContent = DIFF_TYPE_MAP[node.diff.type] || node.diff.type;
                    typeCell.appendChild(diffIndicator);
                    
                    // é•œåƒä¸€æ–‡ä»¶ä¿¡æ¯åˆ—
                    const info1Cell = document.createElement('td');
                    info1Cell.className = 'file-info-column';
                    renderFileInfo(info1Cell, node.diff.item1);
                    
                    // é•œåƒäºŒæ–‡ä»¶ä¿¡æ¯åˆ—
                    const info2Cell = document.createElement('td');
                    info2Cell.className = 'file-info-column';
                    renderFileInfo(info2Cell, node.diff.item2);
                    
                    row.appendChild(pathCell);
                    row.appendChild(typeCell);
                    row.appendChild(info1Cell);
                    row.appendChild(info2Cell);
                    
                    parentElement.appendChild(row);
                }
            }
        }

        // æ¸²æŸ“æ–‡ä»¶ä¿¡æ¯
        function renderFileInfo(cell, fileInfo) {
            if (!fileInfo) {
                cell.textContent = 'N/A';
                return;
            }
            
            const infoContainer = document.createElement('div');
            
            // æ–‡ä»¶å¤§å°
            const sizeItem = document.createElement('div');
            sizeItem.className = 'file-info-item size-info';
            sizeItem.innerHTML = `<strong>å¤§å°:</strong> ${formatSize(fileInfo.size)}`;
            infoContainer.appendChild(sizeItem);
            
            // ä¿®æ”¹æ—¶é—´
            const mtimeItem = document.createElement('div');
            mtimeItem.className = 'file-info-item mtime-info';
            mtimeItem.innerHTML = `<strong>ä¿®æ”¹æ—¶é—´:</strong> ${formatDate(fileInfo.mtime)}`;
            infoContainer.appendChild(mtimeItem);
            
            // MD5å€¼
            if (fileInfo.md5) {
                const md5Item = document.createElement('div');
                md5Item.className = 'file-info-item md5-info';
                md5Item.innerHTML = `<strong>MD5:</strong> ${fileInfo.md5}`;
                infoContainer.appendChild(md5Item);
            }
            
            cell.appendChild(infoContainer);
        }

        // åˆ‡æ¢ç›®å½•å±•å¼€/æŠ˜å 
        function toggleDirectory(event, node, row) {
            event.stopPropagation();
            const expandIcon = event.target;
            const childrenContainer = row.nextElementSibling;
            
            if (childrenContainer && childrenContainer.className === 'children-container') {
                if (childrenContainer.style.display === 'none' || childrenContainer.style.display === '') {
                    childrenContainer.style.display = 'table-row';
                    expandIcon.classList.add('expanded');
                    expandIcon.textContent = 'â–¼';
                } else {
                    childrenContainer.style.display = 'none';
                    expandIcon.classList.remove('expanded');
                    expandIcon.textContent = 'â–¶';
                }
            }
        }

        // åŠ è½½å·®å¼‚æ•°æ®
        function loadDiffData() {
            const loadingElement = document.getElementById('loading');
            const errorElement = document.getElementById('error');
            const tableElement = document.getElementById('diff-table');
            const tableBody = document.getElementById('diff-table-body');
            
            try {
                // ä½¿ç”¨åµŒå…¥å¼çš„å·®å¼‚æ•°æ®
                const diffResult = diffData;
                
                // æ›´æ–°å¤´éƒ¨ä¿¡æ¯
                document.getElementById('image1-name').textContent = diffResult.image1_name || diffResult.dir1.split(/[\\/]/).pop();
                document.getElementById('image2-name').textContent = diffResult.image2_name || diffResult.dir2.split(/[\\/]/).pop();
                document.getElementById('file-info-1').textContent = `é•œåƒä¸€: ${diffResult.image1_name || diffResult.dir1.split(/[\\/]/).pop()}`;
                document.getElementById('file-info-2').textContent = `é•œåƒäºŒ: ${diffResult.image2_name || diffResult.dir2.split(/[\\/]/).pop()}`;
                document.getElementById('compare-dir').textContent = diffResult.compare_dir;
                document.getElementById('diff-count').textContent = diffResult.differences.length;
                
                // æ„å»ºç›®å½•ç»“æ„
                const directoryStructure = buildDirectoryStructure(diffResult.differences);
                
                // æ¸²æŸ“è¡¨æ ¼
                tableBody.innerHTML = '';
                renderDirectoryStructure(directoryStructure, tableBody);
                
                // æ˜¾ç¤ºè¡¨æ ¼ï¼Œéšè—åŠ è½½çŠ¶æ€
                loadingElement.style.display = 'none';
                errorElement.style.display = 'none';
                tableElement.style.display = 'table';
            } catch (error) {
                console.error('åŠ è½½å·®å¼‚æ•°æ®å¤±è´¥:', error);
                loadingElement.style.display = 'none';
                errorElement.style.display = 'block';
                tableElement.style.display = 'none';
            }
        }

        // é¡µé¢åŠ è½½å®ŒæˆååŠ è½½æ•°æ®
        document.addEventListener('DOMContentLoaded', loadDiffData);
    </script>
</body>
</html>